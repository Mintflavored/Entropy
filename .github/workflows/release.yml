name: Entropy Automated Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write # Необходим для создания релиза
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Нужно для получения сообщений тегов
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.14.2'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build with PyInstaller
      run: |
        pyinstaller --name Entropy --windowed --onedir --add-data "resources;resources" --add-data "core;core" --add-data "ai;ai" --add-data "src;src" --hidden-import=paramiko --hidden-import=pandas --hidden-import=openai --hidden-import=anthropic --hidden-import=google.generativeai --hidden-import=dotenv src/main_qml.py
        
    - name: Bundle Server Scripts
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "dist/Entropy/server"
        Copy-Item -Path "scripts/server/*" -Destination "dist/Entropy/server/" -Recurse
        
    - name: Create Zip Archive
      shell: pwsh
      run: |
        Compress-Archive -Path "dist/Entropy/*" -DestinationPath "Entropy-Full-Bundle-${{ github.ref_name }}.zip"
        
    - name: Extract Release Notes
      id: release_notes
      shell: bash
      run: |
        if [ -f "RELEASE_NOTES.md" ]; then
          echo "Reading from RELEASE_NOTES.md"
          # Читаем файл и экранируем спецсимволы для GitHub Output
          CONTENT=$(cat RELEASE_NOTES.md)
          # Используем EOF для многострочного вывода
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "Reading from Tag Message"
          TAG_MSG=$(git tag -l --format='%(contents:body)' ${{ github.ref_name }})
          if [ -z "$TAG_MSG" ]; then
            TAG_MSG="Automatic release for version ${{ github.ref_name }}"
          fi
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: Entropy-Full-Bundle-*.zip
        body: ${{ steps.release_notes.outputs.body }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
